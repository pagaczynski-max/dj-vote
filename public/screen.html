<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>STARCUP JUKEBOX LIVE ‚Äî √âcran</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <script src="/socket.io/socket.io.js"></script>
  <script src="/client.js"></script>

  <style>
    .screenGrid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
      align-items:start;
    }
    @media(max-width:980px){ .screenGrid{ grid-template-columns:1fr } }

    .status{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(121,235,251,.18);
      background: rgba(0,0,0,.18);
      font-weight:900;
      color: rgba(255,255,255,.88);
    }

    .bars { display:flex; flex-direction:column; gap:12px; margin-top:10px; }

    .barRow{
      border:1px solid rgba(121,235,251,.18);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .barRow.leader{
      border-color: rgba(252,25,120,.40);
      box-shadow: 0 18px 60px rgba(252,25,120,.12);
    }

    .barTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      position:relative;
      z-index:2;
    }

    .trackName{ font-weight:900; font-size:18px; }
    .trackArtist{
      font-weight:800;
      font-size:13px;
      color: rgba(251,211,174,.85);
      margin-top:4px;
    }
    .count{
      font-weight:900;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
    }

    /* ‚úÖ Transition visible */
    .fill{
      position:absolute;
      left:0; top:0; bottom:0;
      width:0%;
      background: linear-gradient(90deg, rgba(121,235,251,.22), rgba(252,25,120,.22));
      z-index:1;
      transition: width .35s ease;
      will-change: width;
    }

    .winnerBox{
      margin-top:12px;
      border-radius:18px;
      padding:14px;
      border:1px solid rgba(121,235,251,.26);
      background: linear-gradient(180deg, rgba(121,235,251,.10), rgba(252,25,120,.08));
    }
    .winnerTitle{
      font-weight:900;
      font-size:16px;
      color: rgba(255,255,255,.92);
    }
    .winnerName{
      margin-top:6px;
      font-weight:900;
      font-size:22px;
    }
    .footerBrand{
      margin-top:14px;
      text-align:right;
      color: rgba(255,255,255,.50);
      font-weight:800;
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="brandTitle">STARCUP JUKEBOX LIVE</div>
        <div class="brandSub">L‚Äôanimation musicale interactive en temps r√©el</div>
      </div>
      <div class="hint" id="roomBadge">Room ‚Äî</div>
    </div>

    <div class="screenGrid">
      <div class="card">
        <div class="label">Scannez pour voter</div>
        <img class="qr" id="qr" alt="QR public" />
        <div class="status" id="status">Connexion‚Ä¶</div>

        <div class="winnerBox" id="winnerBox" style="display:none;">
          <div class="winnerTitle">üèÜ Gagnant valid√©</div>
          <div class="winnerName" id="winnerName"></div>
        </div>

        <div class="footerBrand">propuls√© par Starcup</div>
      </div>

      <div class="card">
        <div class="label">R√©sultats en direct</div>
        <div class="pill" id="votesCount">0 votes en direct</div>
        <div class="bars" id="bars"></div>
      </div>
    </div>
  </div>

<script>
  const roomCode = (qs("room") || "").toUpperCase();
  const roomBadge = document.getElementById("roomBadge");
  const qrImg = document.getElementById("qr");
  const statusEl = document.getElementById("status");
  const barsEl = document.getElementById("bars");
  const votesCountEl = document.getElementById("votesCount");
  const winnerBox = document.getElementById("winnerBox");
  const winnerName = document.getElementById("winnerName");

  if (!roomCode) {
    statusEl.textContent = "‚ùå Room manquante. Ouvre screen.html?room=CODE";
  } else {
    roomBadge.textContent = "Room " + roomCode;
    qrImg.src = `/api/room/${encodeURIComponent(roomCode)}/qr?ts=${Date.now()}`;
  }

  const socket = io({ transports: ["websocket"] });

  // On garde les "fill" existants pour pouvoir animer par update sans tout recr√©er
  const fillByTrackId = new Map();
  const rowByTrackId = new Map();
  const countByTrackId = new Map();

  function ensureRows(suggestions) {
    // Reset si nouvelle liste (nouveau vote)
    barsEl.innerHTML = "";
    fillByTrackId.clear();
    rowByTrackId.clear();
    countByTrackId.clear();

    for (const t of suggestions) {
      const row = document.createElement("div");
      row.className = "barRow";

      const fill = document.createElement("div");
      fill.className = "fill";
      fill.style.width = "0%"; // ‚úÖ d√©part √† 0
      row.appendChild(fill);

      const top = document.createElement("div");
      top.className = "barTop";

      const left = document.createElement("div");
      const name = document.createElement("div");
      name.className = "trackName";
      name.textContent = t.title;

      const artist = document.createElement("div");
      artist.className = "trackArtist";
      artist.textContent = t.artist;

      left.appendChild(name);
      left.appendChild(artist);

      const right = document.createElement("div");
      right.className = "count";
      right.textContent = "0";

      top.appendChild(left);
      top.appendChild(right);

      row.appendChild(top);
      barsEl.appendChild(row);

      fillByTrackId.set(t.id, fill);
      rowByTrackId.set(t.id, row);
      countByTrackId.set(t.id, right);
    }

    // ‚úÖ Force le navigateur √† prendre en compte le 0% avant de passer au %
    requestAnimationFrame(() => {});
  }

  let lastSuggestionsKey = "";

  function render(state) {
    const total = sumVotes(state.votes);
    votesCountEl.textContent = `${total} vote${total>1?"s":""} en direct`;

    const hasVote = !!state.voteOpen;
    const hasSuggestions = Array.isArray(state.suggestions) && state.suggestions.length > 0;

    if (!hasVote) {
      statusEl.textContent = hasSuggestions ? "Vote termin√©" : "Aucun vote en cours";
    } else {
      statusEl.textContent = "Vote en cours";
    }

    if (!hasSuggestions) {
      barsEl.innerHTML = "";
      const empty = document.createElement("div");
      empty.className = "status";
      empty.textContent = "En attente d‚Äôun vote‚Ä¶";
      barsEl.appendChild(empty);
      winnerBox.style.display = "none";
      return;
    }

    const key = state.suggestions.map(t => t.id).join("|");
    if (key !== lastSuggestionsKey) {
      lastSuggestionsKey = key;
      ensureRows(state.suggestions);
    }

    // Max votes pour calcul % (si 0 -> 1)
    let max = 1;
    for (const t of state.suggestions) max = Math.max(max, state.votes[t.id] || 0);

    const lead = leaderId(state.suggestions, state.votes);

    for (const t of state.suggestions) {
      const c = state.votes[t.id] || 0;
      const pct = Math.round((c / max) * 100);

      const fill = fillByTrackId.get(t.id);
      const row = rowByTrackId.get(t.id);
      const count = countByTrackId.get(t.id);

      if (count) count.textContent = String(c);

      if (row) {
        // leader seulement si >0 vote total
        if (t.id === lead && total > 0) row.classList.add("leader");
        else row.classList.remove("leader");
      }

      if (fill) {
        // ‚úÖ animation progressive garantie
        requestAnimationFrame(() => {
          fill.style.width = `${pct}%`;
        });
      }
    }

    if (!state.voteOpen && state.lastWinner) {
      winnerBox.style.display = "block";
      winnerName.textContent = `${state.lastWinner.title} ‚Äî ${state.lastWinner.artist}`;
    } else {
      winnerBox.style.display = "none";
      winnerName.textContent = "";
    }

    blurActiveSoon();
  }

  socket.on("connect", () => {
    if (!roomCode) return;
    socket.emit("join", { roomCode });
  });

  socket.on("round_update", (state) => render(state));
  socket.on("validated", ({ winner }) => {
    if (winner) {
      winnerBox.style.display = "block";
      winnerName.textContent = `${winner.title} ‚Äî ${winner.artist}`;
    }
  });

  blurActiveSoon();
</script>
</body>
</html>
