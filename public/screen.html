<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Starcup Jukebox Live ‚Äî √âcran</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Raleway:wght@400;600;800;900&display=swap');

    :root{
      --pink:#FC1978;
      --blue:#79EBFB;
      --violet:#8D20C6;
      --violetDark:#590D7D;
      --dark:#210D41;
      --cream:#FBD3AE;

      --text: rgba(255,255,255,.95);
      --muted: rgba(251,211,174,.82);

      --border: rgba(121,235,251,.22);
      --glass: rgba(33,13,65,.55);
      --glass2: rgba(33,13,65,.35);
      --shadow: 0 26px 80px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Raleway, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 12% 0%, rgba(121,235,251,.18), transparent 60%),
        radial-gradient(900px 520px at 88% 8%, rgba(252,25,120,.18), transparent 60%),
        radial-gradient(1100px 700px at 50% 120%, rgba(141,32,198,.22), transparent 55%),
        linear-gradient(180deg, var(--dark), #07050f);
      min-height:100vh;
      padding:32px;
    }

    .top{
      display:flex;
      justify-content:space-between;
      gap:18px;
      align-items:flex-start;
      flex-wrap:wrap
    }

    .brandTitle{
      font-weight:900;
      letter-spacing:1px;
      color:var(--blue);
      font-size:26px;
      line-height:1.1;
    }
    .brandSub{
      margin-top:8px;
      color:var(--muted);
      font-weight:800;
      font-size:18px;
    }

    .room{
      margin-top:10px;
      color:rgba(255,255,255,.75);
      font-size:16px;
      font-weight:800
    }

    .qrWrap{
      display:flex;
      gap:16px;
      align-items:center;
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border:1px solid var(--border);
      border-radius:22px;
      padding:14px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }

    .qr{
      width:220px;
      height:220px;
      background:#fff;
      border-radius:18px;
      padding:10px;
      border:1px solid rgba(121,235,251,.35)
    }

    .scan{
      font-size:20px;
      font-weight:900;
      margin-bottom:6px;
      color: rgba(255,255,255,.95);
    }

    .url{
      font-size:16px;
      color:rgba(251,211,174,.85);
      word-break:break-all;
      max-width:520px;
      font-weight:700
    }

    .powered{
      margin-top:18px;
      color:rgba(251,211,174,.90);
      font-weight:800;
      letter-spacing:.3px;
      font-size:18px;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:22px;
      margin-top:18px;
    }

    .card{
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border:1px solid var(--border);
      border-radius:22px;
      padding:22px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
      min-height:190px;
      position:relative;
      outline: 0px solid transparent;
      transition: outline .15s ease, transform .15s ease, box-shadow .15s ease;
    }

    .card.leader{
      outline: 4px solid rgba(252,25,120,.65);
      box-shadow: 0 0 0 1px rgba(252,25,120,.30), 0 18px 80px rgba(252,25,120,.18);
      transform: translateY(-2px);
    }

    .title{
      font-size:34px;
      font-weight:900;
      line-height:1.05;
      margin:0 0 8px
    }

    .artist{
      font-size:18px;
      color:var(--muted);
      font-weight:800;
      margin-bottom:16px
    }

    .bar{
      height:14px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(121,235,251,.18);
      overflow:hidden;
    }

    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--blue), var(--pink));
      border-radius:999px;
      transition:width .25s ease;
    }

    .count{
      margin-top:10px;
      font-size:16px;
      color:rgba(255,255,255,.88);
      font-weight:900
    }

    .winnerPill{
      margin-top:20px;
      display:inline-block;
      padding:14px 20px;
      border-radius:999px;
      background: linear-gradient(90deg, var(--blue), var(--pink));
      color:#12081f;
      font-size:30px;
      font-weight:900;
      box-shadow: 0 26px 80px rgba(121,235,251,.16);
    }

    .muted{
      margin-top:16px;
      color:var(--muted);
      font-size:18px;
      font-weight:800;
    }

    .bigEmpty{
      margin-top:18px;
      padding: 22px;
      border-radius: 22px;
      border: 1px solid rgba(121,235,251,.18);
      background: rgba(0,0,0,.20);
      color: rgba(251,211,174,.85);
      font-size: 26px;
      font-weight: 900;
      text-align: center;
    }

    @media(max-width:1050px){
      .grid{grid-template-columns:1fr}
      .qr{width:200px;height:200px}
      .title{font-size:30px}
      .brandSub{font-size:16px}
    }
  </style>
</head>
<body>
  <div class="top">
    <div>
      <div class="brandTitle">STARCUP JUKEBOX LIVE</div>
      <div class="brandSub">L‚Äôanimation musicale interactive en temps r√©el</div>
      <div class="room" id="room"></div>
    </div>

    <div class="qrWrap">
      <img class="qr" id="qr" alt="QR code" />
      <div>
        <div class="scan">Scannez pour choisir le prochain titre</div>
        <div class="url" id="voteUrl"></div>
      </div>
    </div>
  </div>

  <div id="winnerWrap"></div>
  <div id="main"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const roomCode = (params.get("room") || "").toUpperCase();

    const roomEl = document.getElementById("room");
    const qrImg = document.getElementById("qr");
    const voteUrlEl = document.getElementById("voteUrl");
    const main = document.getElementById("main");
    const winnerWrap = document.getElementById("winnerWrap");

    if (!roomCode) {
      roomEl.textContent = "‚ùå Room manquante (?room=ABC123)";
    } else {
      roomEl.textContent = "Room : " + roomCode;
      const voteUrl = `${location.origin}/vote.html?room=${roomCode}`;
      voteUrlEl.textContent = voteUrl;
      qrImg.src = `/api/room/${roomCode}/qr?ts=${Date.now()}`;
    }

    const socket = io({ transports: ["websocket"] });
    socket.emit("join", { roomCode });

    socket.on("round_update", (state) => {
      // Dernier gagnant valid√©
      winnerWrap.innerHTML = "";
      if (state.lastWinner) {
        const w = document.createElement("div");
        w.className = "winnerPill";
        w.textContent = `üèÜ Gagnant valid√© : ${state.lastWinner.title} ‚Äî ${state.lastWinner.artist}`;
        winnerWrap.appendChild(w);
      } else {
        const m = document.createElement("div");
        m.className = "muted";
        m.textContent = "Aucun gagnant valid√© pour l‚Äôinstant.";
        winnerWrap.appendChild(m);
      }

      // Vote ferm√©
      if (!state.voteOpen) {
        main.innerHTML = `<div class="bigEmpty">Aucun vote en cours‚Ä¶<div style="margin-top:10px;font-size:18px;font-weight:800;color:rgba(251,211,174,.85)">Scannez le QR pour rejoindre la session</div></div>`;
        return;
      }

      const suggestions = state.suggestions || [];
      const counts = suggestions.map(t => state.votes[t.id] || 0);
      const max = Math.max(1, ...counts);

      // leader
      let leaderId = null;
      let best = -1;
      for (const t of suggestions) {
        const c = state.votes[t.id] || 0;
        if (c > best) { best = c; leaderId = t.id; }
      }

      const powered = document.createElement("div");
      powered.className = "powered";
      powered.textContent = "Vote en direct ‚Ä¢ propuls√© par Starcup";

      const grid = document.createElement("div");
      grid.className = "grid";

      for (const t of suggestions) {
        const count = state.votes[t.id] || 0;
        const pct = Math.round((count / max) * 100);

        const card = document.createElement("div");
        card.className = "card" + (t.id === leaderId ? " leader" : "");
        card.innerHTML = `
          <div class="title">${escapeHtml(t.title)}</div>
          <div class="artist">${escapeHtml(t.artist)}</div>
          <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
          <div class="count">Votes : ${count}</div>
        `;
        grid.appendChild(card);
      }

      main.innerHTML = "";
      main.appendChild(powered);
      main.appendChild(grid);
    });

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }
  </script>
</body>
</html>
