<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>STARCUP JUKEBOX LIVE — Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <script src="/socket.io/socket.io.js"></script>
  <script src="/client.js"></script>

  <style>
    .mobileWrap{ max-width:540px; margin:0 auto; }
    .hero{
      padding:16px;
      border-radius:18px;
      border:1px solid rgba(121,235,251,.18);
      background: rgba(0,0,0,.18);
    }
    .heroTitle{
      font-weight:900;
      font-size:18px;
      margin:0;
    }
    .heroSub{
      margin-top:8px;
      margin-bottom:0;
      color: rgba(251,211,174,.85);
      font-weight:800;
    }

    .choices{ display:flex; flex-direction:column; gap:12px; margin-top:14px; }

    .choiceBtn{
      width:100%;
      text-align:left;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(121,235,251,.20);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.94);
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    .choiceBtn .artist{
      display:block;
      margin-top:6px;
      font-size:13px;
      color: rgba(251,211,174,.85);
      font-weight:800;
    }

    .choiceBtn.selected{
      border-color: rgba(252,25,120,.45);
      background: linear-gradient(90deg, rgba(121,235,251,.14), rgba(252,25,120,.14));
      box-shadow: 0 18px 60px rgba(252,25,120,.10);
    }

    .choiceBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .info{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(121,235,251,.18);
      background: rgba(0,0,0,.18);
      font-weight:900;
      color: rgba(255,255,255,.88);
    }
  </style>
</head>

<body>
  <div class="mobileWrap">
    <div class="topbar">
      <div>
        <div class="brandTitle">STARCUP JUKEBOX LIVE</div>
        <div class="brandSub">⭐ Expérience Starcup</div>
      </div>
      <div class="hint" id="roomBadge">Room —</div>
    </div>

    <div class="hero">
      <p class="heroTitle">Vote pour le prochain titre</p>
      <p class="heroSub" id="subtitle">Connexion…</p>
    </div>

    <div class="choices" id="choices"></div>
    <div class="info" id="info">En attente…</div>
  </div>

<script>
  const roomCode = (qs("room") || "").toUpperCase();
  const roomBadge = document.getElementById("roomBadge");
  const subtitle = document.getElementById("subtitle");
  const choicesEl = document.getElementById("choices");
  const infoEl = document.getElementById("info");

  if (!roomCode) {
    subtitle.textContent = "❌ Room manquante. Scanne le QR sur l’écran.";
  } else {
    roomBadge.textContent = "Room " + roomCode;
  }

  const voterId = getOrCreateVoterId();
  const socket = io({ transports: ["websocket"] });

  let currentRoundId = null;
  let voteOpen = false;
  let selectedTrackId = null;
  let lastWinner = null;

  function setInfo(text){ infoEl.textContent = text; }

  function renderChoices(suggestions){
    choicesEl.innerHTML = "";

    if (!Array.isArray(suggestions) || suggestions.length === 0) {
      const empty = document.createElement("div");
      empty.className = "info";
      empty.textContent = "Aucun vote en cours. Attends l’ouverture du vote.";
      choicesEl.appendChild(empty);
      return;
    }

    for (const t of suggestions) {
      const btn = document.createElement("button");
      btn.className = "choiceBtn" + (t.id === selectedTrackId ? " selected" : "");
      btn.disabled = !voteOpen;
      btn.type = "button";

      btn.innerHTML = `${t.title}<span class="artist">${t.artist}</span>`;

      btn.addEventListener("click", () => {
        if (!voteOpen || !currentRoundId) return;

        selectedTrackId = t.id;
        renderChoices(suggestions);

        socket.emit("vote", {
          roomCode,
          roundId: currentRoundId,
          trackId: t.id,
          voterId
        });

        setInfo("✅ Vote enregistré ⭐ (tu peux changer)");
        blurActiveSoon();
      });

      choicesEl.appendChild(
